// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===================================================================
// 1. USUÁRIOS
// ===================================================================

model User {
  id             String   @id @default(uuid())
  matricula      String   @unique
  nome           String
  email          String   @unique
  senha_hash     String
  cargo          String?  
  status_usuario String   @default("ATIVO") 
  tipo_perfil    String   @default("ANALISTA")

  // --- CAMPO ADICIONADO PARA CORRIGIR O ERRO DE BUILD ---
  id_unidade_operacional_fk String?
  // ------------------------------------------------------

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ocorrencias    Ocorrencia[] @relation("UsuarioAbertura")
  uploads        Midia[]
  logs           AuditLog[]

  @@map("usuarios")
}

// ===================================================================
// 2. AUDITORIA
// ===================================================================

model AuditLog {
  id        String   @id @default(uuid())
  action    String   
  details   String?  @db.Text
  ipAddress String?
  timestamp DateTime @default(now())
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("audit_logs")
}

// ===================================================================
// 3. OCORRÊNCIAS (Corrigido: 'situacao' -> 'status')
// ===================================================================

model Ocorrencia {
  id               String   @id @default(uuid())
  
  // --- ETAPA 1: Formulário Básico ---
  ponto_base       String?  
  ome_gb_secao     String?  
  viatura_tipo     String?  
  viatura_numero   String?  
  
  nr_aviso         String?  
  data_ocorrencia  DateTime? 
  
  cod_co           String?  
  cod_ciods        String?  
  cod_193          String?  
  
  tipo             String   
  subtipo          String?  

  // --- CORREÇÃO AQUI ---
  status           String   @default("PENDENTE") // Era 'situacao', agora é 'status'
  // ---------------------

  prioridade       String   @default("MEDIA")     
  
  // --- LOCALIZAÇÃO ---
  rua_avenida      String?  
  numero_local     String?
  bairro           String   
  municipio        String?  @default("Recife")
  codigo_local     String?  
  ponto_referencia String?
  
  latitude         Float?   
  longitude        Float?   

  // Datas
  data_acionamento DateTime
  hora_acionamento DateTime
  data_fechamento  DateTime?

  // --- ETAPA 2: Detalhes ---
  veiculos_envolvidos String? 
  historico_texto     String? @db.Text 
  
  guarnicao_posto_grad  String?
  guarnicao_matricula   String?
  guarnicao_nome_guerra String?
  guarnicao_data        DateTime?
  guarnicao_componentes Json? 

  // --- ETAPA 3: Mídia ---
  assinatura_digital    String? @db.LongText 
  formularios_extras    Json?   
  outro_relatorio_tipo  String? 
  observacoes           String? @db.Text
  
  // Vítimas
  vitimas_total         Int     @default(0)
  vitimas_feridas       Int     @default(0)
  vitimas_fatais        Int     @default(0)
  vitimas_ilesas        Int     @default(0)
  vitimas_desaparecidas Int     @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relacionamentos
  id_usuario_fk    String
  usuario          User     @relation("UsuarioAbertura", fields: [id_usuario_fk], references: [id])
  
  vitimas_detalhe  Vitima[]
  midias           Midia[]

  @@index([status]) // Index atualizado
  @@index([prioridade])
  @@index([bairro])
  @@index([tipo])
  @@map("ocorrencias")
}

// ===================================================================
// 4. DETALHES
// ===================================================================

model Vitima {
  id               String     @id @default(uuid())
  nome             String?
  idade            Int?
  situacao         String?    
  id_ocorrencia_fk String
  ocorrencia       Ocorrencia @relation(fields: [id_ocorrencia_fk], references: [id], onDelete: Cascade)

  @@index([id_ocorrencia_fk])
  @@map("vitimas")
}

model Midia {
  id               String     @id @default(uuid())
  url              String     
  tipo             String     
  id_ocorrencia_fk String
  ocorrencia       Ocorrencia @relation(fields: [id_ocorrencia_fk], references: [id], onDelete: Cascade)
  
  id_usuario_fk    String
  usuario          User       @relation(fields: [id_usuario_fk], references: [id])

  createdAt        DateTime   @default(now())

  @@index([id_ocorrencia_fk])
  @@map("midias")
}